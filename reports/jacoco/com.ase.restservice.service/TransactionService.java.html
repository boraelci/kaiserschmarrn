<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TransactionService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">rest-service-initial</a> &gt; <a href="index.source.html" class="el_package">com.ase.restservice.service</a> &gt; <span class="el_source">TransactionService.java</span></div><h1>TransactionService.java</h1><pre class="source lang-java linenums">package com.ase.restservice.service;

import com.ase.restservice.exception.AccountNotFoundException;
import com.ase.restservice.exception.InvalidOrderTypeException;
import com.ase.restservice.exception.InvalidTransactionException;
import com.ase.restservice.exception.ResourceNotFoundException;
import com.ase.restservice.model.Asset;
import com.ase.restservice.model.Stock;
import com.ase.restservice.model.Transaction;
import com.ase.restservice.repository.TransactionRepository;
import java.util.List;
import java.util.Objects;
import java.util.Optional;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

/**
 * Service for Transaction operations.
 */
@Service
<span class="fc" id="L21">public final class TransactionService implements TransactionServiceI {</span>
  @Autowired
  private TransactionRepository transactionRepository;
  @Autowired private AssetService assetService;
  @Autowired private StockService stockService;
  @Autowired
  private AccountService accountService;

  /**
   * Write a new transaction to the database.
   * @param transaction new Transaction
   * @return returns the asset that was created/affected by this transaction
   * @throws AccountNotFoundException if account is not found in database
   * @throws ResourceNotFoundException if user does not have the asset
   * @throws InvalidOrderTypeException when transaction type is not buy or sell
   * @throws InvalidTransactionException if user does not have sufficient assets
   */
  public Optional&lt;Asset&gt; createTransaction(Transaction transaction)
      throws AccountNotFoundException, ResourceNotFoundException,
      InvalidOrderTypeException, InvalidTransactionException {
<span class="nc" id="L41">    transactionRepository.save(transaction);</span>
<span class="nc" id="L42">    return executeTransaction(transaction);</span>
  }

  /**
   * Update a transaction status in the database.
   * @param transaction transaction to update
   * @param status new status
   */
  public void updateTransactionStatus(Transaction transaction, String status) {
<span class="fc" id="L51">    transaction.setTransactionStatus(status);</span>
<span class="fc" id="L52">    transactionRepository.save(transaction);</span>
<span class="fc" id="L53">  }</span>

  /**
   * Executes transactions to buy/sell assets. Directs to helper methods based on transaction type.
   *
   * @param transaction Transaction object placed
   * @return return the updated asset unless the asset was deleted (in the case the user sold
   *        all the shares of the asset), then return null.
   * @throws AccountNotFoundException if account is not found in database
   * @throws ResourceNotFoundException if user does not have the asset
   * @throws InvalidOrderTypeException when transaction type is not buy or sell
   * @throws InvalidTransactionException if user does not have sufficient assets
   */
  public Optional&lt;Asset&gt; executeTransaction(Transaction transaction)
      throws AccountNotFoundException, ResourceNotFoundException,
      InvalidOrderTypeException, InvalidTransactionException {
<span class="nc" id="L69">    Stock stock = stockService.getStockById(transaction.getStockId());</span>
<span class="nc" id="L70">    String transactionType = transaction.getTransactionType();</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">    if (Objects.equals(transactionType, &quot;BUY&quot;)) {</span>
<span class="nc" id="L72">      return Optional.of(buyTransaction(transaction, stock));</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">    } else if (Objects.equals(transactionType, &quot;Sell&quot;)) {</span>
<span class="nc" id="L74">      return sellTransaction(transaction, stock);</span>
    } else {
<span class="nc" id="L76">      throw new InvalidOrderTypeException(&quot;Invalid order type :: &quot; + transactionType);</span>
    }
  }

  /**
   * Executes buy transactions by doing the following: Updating/creating account asset,
   * updating account balance, updating transaction status.
   *
   * @param transaction Transaction object to be executed, with transactionType=&quot;BUY&quot;
   * @param stock Stock to be bought
   * @return account's updated asset after the buyTransaction has been executed
   * @throws AccountNotFoundException if account does not exist in the database
   */
  public Asset buyTransaction(Transaction transaction, Stock stock)
      throws AccountNotFoundException {
    // UPDATE/CREATE ASSET
<span class="fc" id="L92">    Asset newAsset = assetService.buyAsset(</span>
<span class="fc" id="L93">        transaction.getAccountId(),</span>
<span class="fc" id="L94">        transaction.getStockId(),</span>
<span class="fc" id="L95">        transaction.getNumShares()</span>
    );
<span class="fc" id="L97">    float totalCost = stock.getPrice() * transaction.getNumShares();</span>
    // UPDATE ACCOUNT BALANCE
    // send the (-) amount of total_cost so that the account service DECREASES the account's balance
<span class="fc" id="L100">    accountService.updateAccountBalance(transaction.getAccountId(), -totalCost);</span>
<span class="fc" id="L101">    updateTransactionStatus(transaction, &quot;COMPLETED&quot;);</span>
<span class="fc" id="L102">    return newAsset;</span>
  }

  /**
   * Executes sell transaction by doing the following: Updating/deleting account asset,
   * updating account balance, updating transaction status.
   *
   * @param transaction Transaction object to be executed, with transactionType=&quot;SELL&quot;
   * @param stock Stock to be sold
   * @return account's updated asset after sellTransaction has been excecuted, return null in
   *        the case that all the asset has been sold (asset has been deleted)
   * @throws AccountNotFoundException if account does not exist in the database
   * @throws InvalidTransactionException if transaction type is not buy or sell
   * @throws ResourceNotFoundException if user does not have sufficient assets
   */
  public Optional&lt;Asset&gt; sellTransaction(Transaction transaction, Stock stock)
      throws AccountNotFoundException, InvalidTransactionException, ResourceNotFoundException {
    // UPDATE/DELETE ASSET
<span class="fc" id="L120">    Optional&lt;Asset&gt; newAsset = assetService.sellAsset(</span>
<span class="fc" id="L121">        transaction.getAccountId(),</span>
<span class="fc" id="L122">        stock.getStockId(),</span>
<span class="fc" id="L123">        transaction.getNumShares());</span>
<span class="fc" id="L124">    float totalCost = stock.getPrice() * transaction.getNumShares();</span>
    // UPDATE ACCOUNT BALANCE
    // SEND THE (+) amount of total_cost so tht the account service INCREASES account's balance
<span class="fc" id="L127">    accountService.updateAccountBalance(transaction.getAccountId(), totalCost);</span>
<span class="fc" id="L128">    updateTransactionStatus(transaction, &quot;COMPLETED&quot;);</span>
<span class="fc" id="L129">    return newAsset;</span>
  }

  /**
   * List all transactions for an account given accountId.
   * @param accountId Unique identifier for account
   * @return List of transactions belonging to account with accountId
   *
   * @throws AccountNotFoundException if account does not exist
   */
  public List&lt;Transaction&gt; listAccountTransactions(String accountId)
      throws AccountNotFoundException {
<span class="nc" id="L141">    return transactionRepository.findByAccountId(accountId)</span>
<span class="nc" id="L142">        .orElseThrow(() -&gt; new AccountNotFoundException(</span>
            &quot;Account not found for accountId :: &quot; + accountId
        ));
  }

  /**
   * List all transactions.
   * @return list of all transactions
   */
  public List&lt;Transaction&gt; listAllTransactions() {
<span class="nc" id="L152">    return transactionRepository.findAll();</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>